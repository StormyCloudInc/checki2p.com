# GitLab CI/CD Configuration for CheckI2P.com
# Includes comprehensive security scanning and testing

variables:
  # SAST configuration
  SAST_EXCLUDED_PATHS: "node_modules/, .git/"
  # Dependency scanning configuration  
  DS_EXCLUDED_PATHS: "node_modules/"
  # Secret detection configuration
  SECRET_DETECTION_EXCLUDED_PATHS: "node_modules/"

stages:
  - build
  - test
  - security
  - deploy

# Cache node_modules between jobs
cache:
  paths:
    - node_modules/

# Build stage - Install dependencies
install_dependencies:
  stage: build
  image: node:18-alpine
  script:
    - npm install
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# Test stage - Run any tests
test_functions:
  stage: test
  image: node:18-alpine
  script:
    - npm install
    - echo "Add tests here when available"
  allow_failure: true

# Include GitLab's security templates
include:
  # Static Application Security Testing
  - template: Security/SAST.gitlab-ci.yml
  # Infrastructure as Code scanning
  - template: Security/IaC-Scanning.gitlab-ci.yml
  # Dynamic Application Security Testing
  - template: Security/DAST.gitlab-ci.yml
  # Dependency Scanning
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  # Secret Detection
  - template: Security/Secret-Detection.gitlab-ci.yml
  # Coverage Fuzzing (requires test suite)
  - template: Security/Coverage-Fuzzing.gitlab-ci.yml
  # API Fuzzing
  - template: Security/API-Fuzzing.gitlab-ci.yml

# SAST configuration override
sast:
  stage: security
  variables:
    SEARCH_MAX_DEPTH: 10
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# IaC Scanning configuration
iac-sast:
  stage: security
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# DAST configuration
dast:
  stage: security
  variables:
    DAST_WEBSITE: "https://checki2p.netlify.app"
    DAST_FULL_SCAN_ENABLED: "true"
    DAST_BROWSER_SCAN: "true"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

# Dependency scanning configuration
gemnasium-dependency_scanning:
  stage: security
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Secret detection configuration  
secret_detection:
  stage: security
  variables:
    SECRET_DETECTION_HISTORIC_SCAN: "true"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Coverage fuzzing configuration (requires test files)
coverage_fuzzing:
  stage: security
  variables:
    COVFUZZ_TESTS_DIR: "tests/"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: true

# API fuzzing configuration
api_fuzzing:
  stage: security
  variables:
    FUZZAPI_TARGET_URL: "https://checki2p.netlify.app/api/ip"
    FUZZAPI_HTTP_USERNAME: ""
    FUZZAPI_HTTP_PASSWORD: ""
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: true

# Custom security checks
custom_security_checks:
  stage: security
  image: node:18-alpine
  script:
    # Check for hardcoded credentials
    - echo "Checking for hardcoded credentials..."
    - |
      if grep -r "API_KEY\|PASSWORD\|SECRET" --include="*.js" --include="*.py" --exclude-dir=node_modules .; then
        echo "Warning: Potential hardcoded credentials found"
      fi
    # Check for sensitive files
    - echo "Checking for sensitive files..."
    - |
      if [ -f .env ]; then
        echo "ERROR: .env file should not be committed"
        exit 1
      fi
    # Verify security headers in netlify.toml
    - echo "Verifying security headers..."
    - grep -q "X-Frame-Options" netlify.toml || echo "Warning: X-Frame-Options header not found"
    - grep -q "X-Content-Type-Options" netlify.toml || echo "Warning: X-Content-Type-Options header not found"
  allow_failure: true

# License scanning
license_scanning:
  stage: security
  image: node:18-alpine
  script:
    - npm install -g license-checker
    - license-checker --production --summary
  allow_failure: true

# Deploy stage (example - adjust for your deployment method)
deploy_preview:
  stage: deploy
  script:
    - echo "Deploy to preview environment"
  only:
    - branches
  except:
    - main
    - master
  when: manual

deploy_production:
  stage: deploy
  script:
    - echo "Deploy to production via Netlify"
  only:
    - main
    - master
  when: manual